<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>คำนวณม่านม้วน</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
  <style>
    .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body class="bg-white">
  <div class="d-flex">
    <aside id="sidebar" class="sidebar p-3 border-end">
      <h5 class="mb-4 fw-bold"><i class="bi bi-calculator me-2"></i>ตัวคำนวณ</h5>
      <nav class="nav flex-column gap-2">
        <a class="nav-link px-3 py-2 rounded hoverable" href="pvc.html"><i class="bi bi-border-width me-2"></i>คำนวณฉากกั้นแอร์</a>
        <a class="nav-link px-3 py-2 rounded hoverable" href="woodblind.html"><i class="bi bi-window-split me-2"></i>คำนวณมู่ลี่ไม้</a>
        <a class="nav-link px-3 py-2 rounded hoverable active" href="roller.html"><i class="bi bi-wind me-2"></i>คำนวณม่านม้วน</a>
        <div class="border-top my-3"></div>
        <a class="nav-link px-3 py-2 rounded hoverable" href="admin.html"><i class="bi bi-gear me-2"></i>ผู้ดูแลระบบ</a>
        <a class="nav-link px-3 py-2 rounded hoverable" href="index.html"><i class="bi bi-house me-2"></i>กลับหน้าแรก</a>
      </nav>
      <div class="mt-auto small text-secondary pt-4">© 2025 Product Calculator</div>
    </aside>
    <main class="flex-grow-1 p-4">
      <div class="container-fluid">
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow-sm border-0">
              <div class="card-body p-4 p-md-5">
                <h1 class="fw-bold mb-3">คำนวณม่านม้วน</h1>
                <p class="text-secondary mb-4">ใส่ขนาดและจำนวนเพื่อคำนวณราคาม่านม้วน</p>
                
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label for="materialType" class="form-label">ประเภทผ้า</label>
                    <select id="materialType" class="form-select">
                      <option value="Dimout">Dimout</option>
                      <option value="Sunscreen">Sunscreen</option>
                      <option value="Blackout">Blackout</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="productCode" class="form-label">รหัสสินค้า</label>
                    <select id="productCode" class="form-select"></select>
                  </div>
                </div>

                <div class="alert alert-info py-2" role="alert">
                  <i class="bi bi-info-circle me-2"></i>ราคาสินค้าต่อตร.ม.: <span id="unitPriceDisplay">0.00</span> บาท
                </div>

                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead class="table-light">
                      <tr>
                        <th class="text-nowrap" style="width: 25%">รหัสสินค้า</th>
                        <th class="text-nowrap" style="width: 15%">กว้าง (เมตร)</th>
                        <th class="text-nowrap" style="width: 15%">สูง (เมตร)</th>
                        <th class="text-nowrap" style="width: 10%">จำนวน</th>
                        <th class="text-nowrap" style="width: 15%">ปรับซ้าย/ขวา</th>
                        <th class="text-nowrap text-end" style="width: 20%">ราคารวม</th>
                        <th style="width: 5%"></th>
                      </tr>
                    </thead>
                    <tbody id="lineItems">
                      <!-- New row will be appended here -->
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="5" class="text-end fw-bold">ราคารวมทั้งหมด</td>
                        <td class="text-end fw-bold fs-5 text-nowrap"><span id="grandTotal">0.00</span></td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div class="d-flex justify-content-between flex-wrap gap-2">
                  <button id="addRowBtn" class="btn btn-outline-primary"><i class="bi bi-plus me-2"></i>เพิ่มรายการ</button>
                  <div class="d-flex gap-2">
                    <button id="calcAllBtn" class="btn btn-outline-secondary"><i class="bi bi-calculator me-2"></i>คำนวณทั้งหมด</button>
                    <button id="quoteBtn" class="btn btn-primary"><i class="bi bi-file-earmark-text me-2"></i>สร้างใบเสนอราคา</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal for quote -->
  <div class="modal fade" id="quoteModal" tabindex="-1" aria-labelledby="quoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="quoteModalLabel">ใบเสนอราคา</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="quoteArea" class="p-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="captureImg" class="btn btn-secondary">บันทึกเป็นรูปภาพ</button>
          <button type="button" id="downloadPdf" class="btn btn-primary">ดาวน์โหลด PDF</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="assets/js/utils.js"></script>

  <script>
    const PRODUCT_DATA = {
      'Dimout': {
        'SOLIX': { price: 290, codes: ['TML-5161', 'TML-5162', 'TML-5163', 'TML-5164', 'TML-5165'] },
        'SHEERO': { price: 290, codes: ['TM-5101', 'TM-5103', 'TM-5104', 'TM-5121', 'TM-5122', 'TM-5123', 'TM-5124'] },
        'ARISO': { price: 349, codes: ['MED-0062', 'MED-0064', 'MED-0065', 'MED-0066', 'MED-0067'] }
      },
      'Sunscreen': {
        'LUMI 3%': { price: 280, codes: ['RSP301', 'RSP302', 'RSP303', 'RSP311'] },
        'LUMI 5%': { price: 280, codes: ['RSP501', 'RSP502', 'RSP503', 'RSP505', 'RPS506', 'RSP509', 'RSP510', 'RSP511', 'RSP512'] }
      },
      'Blackout': {
        'AUROSUN': { price: 399, codes: ['A5-0002', 'A5-0003', 'A5-0004', 'A5-0005', 'A5-0006', 'A5-0007', 'A5-0008'] },
        'BUOVI': { price: 399, codes: ['SZH-0021', 'SZH-0022', 'SZH-0024', 'SZH-0028', 'SZH-0029'] },
        'KOALA NOVA': { price: 280, codes: ['RBP-3901', 'RBP-3902', 'RBP-3903', 'RBP-3908', 'RBP-3909', 'RBP-3910', 'RBP-3911', 'RBP-3912', 'RBP-3913', 'RBP-3914'] },
        'Black out Promotion': { price: 259, codes: ['RBP-3901', 'RBP-3902', 'RBP-3903', 'RBP-3908', 'RBP-3909', 'RBP-3910', 'RBP-3911', 'RBP-3912', 'RBP-3913', 'RBP-3914'] }
      }
    };

    const unitPriceDisplay = document.getElementById('unitPriceDisplay');
    const materialTypeSelect = document.getElementById('materialType');
    const productCodeSelect = document.getElementById('productCode');
    const lineItemsContainer = document.getElementById('lineItems');
    const grandTotalSpan = document.getElementById('grandTotal');
    const quoteModal = new bootstrap.Modal('#quoteModal');

    // Function to calculate the total for a single row
    const calculateLineTotal = (w, h, qty, price) => {
      if (!w || !h || !qty || !price) return 0;
      // The formula: width * height * 1.2 * price
      return w * h * 1.2 * price * qty;
    };

    // Function to calculate the grand total
    const calculateGrandTotal = () => {
      let total = 0;
      const rows = lineItemsContainer.querySelectorAll('.line-row');
      rows.forEach(row => {
        const w = parseFloat(row.querySelector('.wVal').value) || 0;
        const h = parseFloat(row.querySelector('.hVal').value) || 0;
        const qty = parseInt(row.querySelector('.qtyVal').value) || 0;
        const price = parseFloat(document.getElementById('unitPriceDisplay').textContent) || 0;
        const lineTotal = calculateLineTotal(w, h, qty, price);
        row.querySelector('.lineTotal').textContent = formatMoney(lineTotal);
        total += lineTotal;
      });
      grandTotalSpan.textContent = formatMoney(total);
      return total;
    };

    // Event listener to trigger calculation on input change
    const setupRowListeners = (row) => {
      const inputs = row.querySelectorAll('.wVal, .hVal, .qtyVal');
      inputs.forEach(input => {
        input.addEventListener('input', calculateGrandTotal);
      });
      row.querySelector('.delete-row-btn').addEventListener('click', (e) => {
        e.target.closest('.line-row').remove();
        calculateGrandTotal();
      });
    };

    // Function to add a new row
    const addRow = () => {
      const row = document.createElement('tr');
      row.className = 'line-row';
      const selectedCode = productCodeSelect.value;
      const selectedCodeText = productCodeSelect.options[productCodeSelect.selectedIndex].text;
      
      row.innerHTML = `
        <td>
          <input type="text" class="form-control code text-nowrap" value="${selectedCodeText}" readonly>
        </td>
        <td>
          <input type="number" class="form-control form-control-sm wVal" step="0.01" min="0" placeholder="กว้าง">
        </td>
        <td>
          <input type="number" class="form-control form-control-sm hVal" step="0.01" min="0" placeholder="สูง">
        </td>
        <td>
          <input type="number" class="form-control form-control-sm qtyVal" step="1" min="1" value="1">
        </td>
        <td>
          <select class="form-select form-select-sm">
            <option>ซ้าย</option>
            <option>ขวา</option>
          </select>
        </td>
        <td class="text-end fw-semibold text-nowrap">
          <span class="lineTotal">0.00</span>
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-danger delete-row-btn"><i class="bi bi-x"></i></button>
        </td>
      `;
      lineItemsContainer.appendChild(row);
      setupRowListeners(row);
    };

    // Function to update the product code dropdown
    const updateProductCodes = () => {
      const material = materialTypeSelect.value;
      // Clear existing options
      productCodeSelect.innerHTML = '';
      
      const productTypes = PRODUCT_DATA[material];
      for (const type in productTypes) {
        const codes = productTypes[type].codes;
        codes.forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = `${code} (${type})`;
          productCodeSelect.appendChild(option);
        });
      }
      updateUnitPrice();
    };

    // Function to update the displayed unit price
    const updateUnitPrice = () => {
      const material = materialTypeSelect.value;
      const selectedCode = productCodeSelect.value;
      let price = 0;
      let type = '';
      for (const t in PRODUCT_DATA[material]) {
        if (PRODUCT_DATA[material][t].codes.includes(selectedCode)) {
          price = PRODUCT_DATA[material][t].price;
          type = t;
          break;
        }
      }
      unitPriceDisplay.textContent = price.toFixed(2);
      // Recalculate all totals when unit price changes
      calculateGrandTotal();
    };

    // Event listeners for dropdowns
    materialTypeSelect.addEventListener('change', updateProductCodes);
    productCodeSelect.addEventListener('change', updateUnitPrice);
    
    // Initial setup
    updateProductCodes();
    addRow();

    // Button event listeners
    document.getElementById('addRowBtn').addEventListener('click', addRow);
    document.getElementById('calcAllBtn').addEventListener('click', calculateGrandTotal);
    
    document.getElementById('quoteBtn').addEventListener('click', () => {
      const grand = calculateGrandTotal();
      const rows = [...lineItemsContainer.querySelectorAll('tr')].map((tr, i) => {
        const w = parseFloat(tr.querySelector('.wVal').value) || 0;
        const h = parseFloat(tr.querySelector('.hVal').value) || 0;
        const price = parseFloat(document.getElementById('unitPriceDisplay').textContent) || 0;
        const lineTotal = calculateLineTotal(w, h, parseInt(tr.querySelector('.qtyVal').value), price);
        const productCodeText = tr.querySelector('.code').value || '-';
        return {
          index: i + 1,
          code: productCodeText,
          w: w,
          h: h,
          qty: parseInt(tr.querySelector('.qtyVal').value) || 0,
          price: price,
          total: lineTotal
        };
      }).filter(r => r.qty > 0 && r.w > 0 && r.h > 0);

      const html = renderQuoteTable({
        title: 'ใบเสนอราคา - ม่านม้วน',
        subtitle: `${materialTypeSelect.options[materialTypeSelect.selectedIndex].text}`,
        rows: rows,
        grand: grand
      });
      document.getElementById('quoteArea').innerHTML = html;
      quoteModal.show();
    });
    
    document.getElementById('captureImg').addEventListener('click', async () => {
      const node = document.getElementById('quoteArea');
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#ffffff' });
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ใบเสนอราคา-ม่านม้วน.png';
      a.click();
    });

    document.getElementById('downloadPdf').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      pdf.html(document.getElementById('quoteArea'), {
        callback: (doc) => {
          doc.save('ใบเสนอราคา-ม่านม้วน.pdf');
        },
        x: 15,
        y: 15,
        width: 180,
      });
    });

  </script>
</body>
</html>
